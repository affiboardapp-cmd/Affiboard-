# 

---

Quero que voc√™ corrija o fluxo de an√°lise do AffiBoard com base no projeto atual (React + Express + Supabase).

üìå OBJETIVO

Quando o usu√°rio entrar em /analyze, ele deve:

1. Inserir uma URL
2. Clicar em ‚ÄúAnalisar‚Äù
3. O frontend React deve chamar:

POST http://0.0.0.0:5000/api/analyze
Authorization: Bearer <JWT>
Content-Type: application/json
Body: { "url": "<url>" }

1. Receber JSON da an√°lise
    
    PROMPT ‚Äî ‚ÄúCORRIGIR /API/ANALYZE + INTEGRAR BACKEND EXPRESS AO FRONTEND REACT‚Äù
    
2. Exibir no componente AnalyzePage
3. Debitar cr√©ditos (j√° est√° implementado no backend)
4. Registrar no usage_history

üõ†Ô∏è TAREFAS QUE VOC√ä PRECISA APLICAR

A partir do estado atual do repo:

---

1. Criar/Atualizar a rota /api/analyze no Express

Local:

/server/routes.ts
/server/index.ts

Requisitos:

Criar POST /api/analyze

Validar header Authorization

Validar token no Supabase (usando supabase-js)

Ler req.body.url

Executar scraper simples HTTP ‚Üí pegar <title> e pre√ßo (regex)

Gerar score simples (como j√° fizemos)

Registrar no Supabase:

usage_history (url, score, user_id)

debit_credits_atomic (1 cr√©dito)

Retornar JSON:

{
"success": true,
"analysis": { ... },
"credits_remaining": number
}

---

1. Ajustar AnalyzePage para consumir backend Express

Local:

client/src/pages/analyze.tsx
client/src/lib/api.ts

Requisitos:

Parar de usar Supabase Edge Function

Migrar para:

fetch('/api/analyze')

Enviar token JWT do Supabase via:

const { data: { session } } = await supabase.auth.getSession();
Authorization: Bearer ${session.access_token}

Exibir loading, erros e resultado

---

1. Criar servi√ßo de API real no frontend

Atualizar:

client/src/lib/api.ts

Substituir analyzeOffer por:

export async function analyzeOffer(url: string) {
const { data: { session } } = await supabase.auth.getSession();
const res = await fetch('/api/analyze', {
method: 'POST',
headers: {
'Authorization': Bearer ${session.access_token},
'Content-Type': 'application/json'
},
body: JSON.stringify({ url })
});
return res.json();
}

---

1. Ajustar o layout

Garantir que navbar n√£o cubra o conte√∫do

Garantir que o bot√£o ‚ÄúAnalisar‚Äù funcione em mobile

Garantir responsividade

---

1. Validar tudo automaticamente

Simule:

Login

Ir para /analyze

Inserir URL

Clicar no bot√£o

Ver se aparece JSON

Ver se cr√©ditos diminuem no profile

Ver se aparece no usage_history

---

1. ENTREGAS

Quero que voc√™ me entregue:

Diff dos arquivos modificados

Arquivos completos atualizados

Diagn√≥stico do que estava errado

Resultado final funcionando

---

IMPORTANTE

N√£o criar nada novo al√©m disso.
N√£o alterar fluxo de Auth.
N√£o mexer no React Router.
Apenas corrigir integra√ß√£o AnalyzePage ‚Üí Express ‚Üí Supabase.

---

‚ú® √â isso ‚Äî aplique as corre√ß√µes imediatamente.