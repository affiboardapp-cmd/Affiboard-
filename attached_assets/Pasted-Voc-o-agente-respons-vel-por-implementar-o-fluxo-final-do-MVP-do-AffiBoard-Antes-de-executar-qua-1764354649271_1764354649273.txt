VocÃª Ã© o agente responsÃ¡vel por implementar o fluxo final do MVP do AffiBoard.
Antes de executar qualquer alteraÃ§Ã£o, vocÃª DEVE:

1. Ler TODO este contexto.


2. Validar se estÃ¡ coerente com o fluxo final aprovado:
reserve â†’ scrape â†’ commit/release


3. Confirmar que nÃ£o irÃ¡ modificar tabelas existentes.


4. Confirmar que usarÃ¡ SUPABASE_SERVICE_ROLE_KEY em TODAS as operaÃ§Ãµes crÃ­ticas.


5. Somente depois disso, gerar e aplicar as alteraÃ§Ãµes.




---

ğŸ“Œ CONTEXTO OFICIAL DO MVP (RESUMO)

O AffiBoard Ã© um SaaS que analisa URLs de ofertas.
O fluxo final e validado por todas as IAs Ã©:

1. Validar JWT


2. Normalizar URL


3. Criar url_hash


4. Verificar cache local (SQLite)


5. Verificar cache remoto (Supabase)


6. Se tiver â†’ retornar sem cobrar


7. Se NÃƒO tiver:

reserve_credits

criar analysis_request

scraping (timeout 10s, 1 retry, UA rotativo)

salvar cache

commit_reservation

erro â†’ release_reservation



8. Retornar JSON: { success, analysis, credits_remaining, cached }




---

ğŸ“Œ SUA MISSÃƒO AGORA

Implementar completamente:

1. Tabelas novas (somente essas):

analysis_requests

credit_reservations

analysis_cache



2. RPCs novas (somente essas):

reserve_credits

commit_reservation

release_reservation



3. Implementar a rota /api/analyze no Express usando:

SERVICE_ROLE_KEY

reserva antes do scrape

timeout

retry

circuit-breaker

commit ou release final



4. Implementar o cache:

Local (SQLite, TTL 7 dias)

Remoto (Supabase, TTL 30 dias)



5. Criar worker scraper separado.


6. Checklist E2E:

anÃ¡lise simples

cache hit

crÃ©dito insuficiente

concorrÃªncia

rollback

circuit-breaker





---

âš ï¸ REGRAS IMPORTANTES

â— NUNCA modifique tabelas jÃ¡ existentes no Supabase
â— NUNCA recrie RPCs existentes sem validar antes
â— TODAS as operaÃ§Ãµes devem usar SERVICE_ROLE_KEY
â— Qualquer falha no scraping â†’ release_reservation
â— NÃ£o use Puppeteer
â— NÃ£o usar Edge Functions
â— RLAE (reserve â†’ log â†’ analyze â†’ execute) Ã© obrigatÃ³rio


---

ğŸ“¦ AGORA EXECUTE:

(1) Gere todo o SQL final, pronto para colar
(2) Gere o /api/analyze completo
(3) Gere os arquivos de cache
(4) Gere o worker
(5) Gere o checklist E2E
(6) Valide tudo sozinho antes de finalizar

Quando terminar, responda:

"IMPLEMENTAÃ‡ÃƒO MVP GERADA E VALIDADA"