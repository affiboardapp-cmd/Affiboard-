Voc√™ agora est√° 100% sincronizado com o estado REAL do meu projeto AffiBoard.
Essas informa√ß√µes foram confirmadas tecnicamente por outro ChatGPT especialista e validadas como corretas, seguras e completas.

üìå CONTEXTO DO PROJETO (OFICIAL)

Frontend React funcionando: login, dashboard, hist√≥rico e an√°lise.

Backend Express configurado, mas ainda sem a rota final /api/analyze.

Edge Functions antigas N√ÉO ser√£o usadas no MVP.

Banco Supabase com perfis, cr√©ditos e hist√≥rico.

O MVP final precisa seguir o fluxo aprovado abaixo.



---

üìå FLUXO FINAL DO MVP (CONFIRMADO PELO CHATGPT ESPECIALISTA)

1. Validar token Supabase (JWT).


2. Normalizar URL (limpar UTM, fbclid, https, trailing slash).


3. Criar url_hash (sha256).


4. Consultar cache local SQLite.


5. Consultar cache Supabase (analysis_cache).


6. Se existir ‚Üí retornar imediatamente (cached: true, sem usar cr√©dito).


7. Se n√£o existir no cache:

criar analysis_request com status "pending"

reservar 1 cr√©dito (RPC: reserve_credits)

executar scraping simples com timeout de 10s

salvar resultado no cache (SQLite + Supabase)

confirmar reserva (RPC: commit_reservation)

em caso de erro ‚Üí devolver cr√©dito (RPC: release_reservation)



8. Frontend exibe resultado.



‚ö†Ô∏è Exig√™ncias t√©cnicas confirmadas:

Todas as reservas devem expirar automaticamente em 5 minutos.

Scraping deve ter timeout de 10s.

RPCs devem ter nomes fixos:
reserve_credits, commit_reservation, release_reservation.

O endpoint deve retornar JSON no formato:
{ success, analysis, credits_remaining, cached }.



---

üìå O QUE VOC√ä DEVE GERAR AGORA (ENTREGA OBRIGAT√ìRIA)

1. C√≥digo completo das 3 RPCs (SQL):

reserve_credits

commit_reservation

release_reservation


2. SQL completo da tabela:

analysis_requests
Com colunas:

id

user_id

url_original

url_normalized

url_hash

status

result JSON

created_at

updated_at


3. Implementa√ß√£o COMPLETA e COMENTADA da rota Express:

/api/analyze
Usando o fluxo final aprovado.

4. Implementa√ß√£o do Cache:

Arquivo SQLite local

Tabela Supabase analysis_cache

TTL: 24h

Promo√ß√£o local ‚Üí remoto


5. Worker/Scraper simples:

axios + cheerio

timeout 10s

retorna { title, price, timestamp }


6. Checklist E2E completo:

Testes:

fluxo normal

cache

cr√©dito insuficiente

reserva/commit

rollback

concorr√™ncia



---

üìå REGRAS OBRIGAT√ìRIAS

1. Use linguagem simples para que eu consiga validar.


2. Gere o c√≥digo completo e funcional.


3. Antes de finalizar ‚Üí
valide automaticamente o c√≥digo, corrija inconsist√™ncias e s√≥ ent√£o entregue.


4. Nada de depender de Edge Functions.


5. Toda a l√≥gica deve rodar no backend Express.




---

Pode come√ßar.

