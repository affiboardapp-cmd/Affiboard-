Objetivo: Resolver o problema de queries que nÃ£o disparam, token nÃ£o enviado e Dashboard travado.
ModificaÃ§Ãµes 100% seguras e necessÃ¡rias.




---

ğŸ”§ 1. Atualizar Dashboard: remover â€œenabled: falseâ€

Arquivo: client/src/pages/dashboard.tsx

AÃ§Ã£o do agente:

> Substitua qualquer ocorrÃªncia de:



enabled: !!session?.access_token,

por:

enabled: true,


---

ğŸ”§ 2. Atualizar authFetch para garantir o envio do token

Arquivo: client/src/lib/queryClient.ts

AÃ§Ã£o do agente:

> Substitua completamente a funÃ§Ã£o authFetch pelo cÃ³digo abaixo:



import { supabase } from "./supabase";

export async function authFetch(url: string, options: any = {}) {
  const { data: { session } } = await supabase.auth.getSession();
  const token = session?.access_token;

  console.log("[AUTHFETCH] Token presente?", !!token);

  const headers = {
    ...(options.headers || {}),
    "Content-Type": "application/json",
    ...(token ? { Authorization: `Bearer ${token}` } : {}),
  };

  const res = await fetch(url, { ...options, headers });

  console.log("[AUTHFETCH] Status:", res.status, url);

  return res;
}


---

ğŸ”§ 3. Corrigir getQueryFn para parar de montar URL errada

Arquivo: client/src/lib/queryClient.ts

AÃ§Ã£o do agente:

> Substitua a funÃ§Ã£o queryFn por:



queryFn: async ({ queryKey }) => {
  const url = queryKey[0]; // CorreÃ§Ã£o â€” nÃ£o usar join()

  const res = await authFetch(url);

  if (!res.ok) {
    console.error("[QUERY ERROR]", url, res.status);
    throw new Error(`HTTP ${res.status}`);
  }

  return res.json();
}


---

ğŸ”§ 4. Garantir que sÃ³ existe uma instÃ¢ncia do Supabase

Arquivo: client/src/lib/queryClient.ts

AÃ§Ã£o do agente:

> Remova qualquer createClient ou createSupabaseClient dentro deste arquivo.
Use somente:



import { supabase } from "./supabase";

Esto elimina os erros:

"Multiple GoTrueClient instances detected"

SessÃµes desincronizadas

Token ausente



---

ğŸ”§ 5. Limpar o cache do Vite (reduz bugs visuais e travamentos)

AÃ§Ã£o do agente: Executar no console do Replit:

rm -rf node_modules/.vite


---

ğŸ”§ 6. Reiniciar o servidor

AÃ§Ã£o do agente: executar:

npm run dev:old

