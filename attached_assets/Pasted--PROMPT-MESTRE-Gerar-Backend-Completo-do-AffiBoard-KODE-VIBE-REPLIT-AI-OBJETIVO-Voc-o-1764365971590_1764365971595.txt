
ðŸ”¥ PROMPT MESTRE â€” Gerar Backend Completo do AffiBoard (KODE / VIBE / REPLIT AI)

OBJETIVO
VocÃª Ã© o agente responsÃ¡vel por gerar o backend completo, funcional e pronto para produÃ§Ã£o do meu SaaS AffiBoard.

O frontend React jÃ¡ estÃ¡ pronto.
O Supabase sÃ³ tem a tabela profiles.
Agora vocÃª precisa implementar toda a parte backend.


---

ðŸ“Œ O QUE VOCÃŠ DEVE FAZER

Quero que vocÃª:

1. Crie toda a estrutura de pastas:



/server
/server/routes
/server/lib
/server/middleware
/server/utils

2. Gerar todos os arquivos completos, incluindo:



server/index.js
server/routes.js
server/routes/analyze.js
server/lib/supabase.js
server/lib/localCache.js
server/lib/scraper.js
server/middleware/auth.js

3. Implementar 100% da rota /api/analyze, com o fluxo MVP final:



validar JWT

validar URL

normalizar URL

gerar url_hash sha256 / 16 chars

checar cache local (SQLite)

checar cache remoto (Supabase: analysis_cache)

reservar crÃ©dito via RPC reserve_credits

scraping via axios + cheerio

salvar cache local + remoto

commit_reservation

release_reservation se der erro

retornar JSON:


{
  "success": true,
  "analysis": { ... },
  "credits_remaining": 14,
  "cached": false
}

4. Implementar biblioteca de cache local SQLite:



TTL

hits/misses

save, get, clear


5. Implementar Supabase client com SERVICE_ROLE_KEY (somente backend)


6. Instalar todas as dependÃªncias necessÃ¡rias:



express
@supabase/supabase-js
axios
cheerio
better-sqlite3
crypto
cors

7. Gerar automaticamente o SQL do Supabase, com:



Tabelas obrigatÃ³rias:

analysis_requests
credit_reservations
analysis_cache

RPCs obrigatÃ³rias:

reserve_credits
commit_reservation
release_reservation

Implemente com:

SECURITY DEFINER

transaÃ§Ãµes atÃ´micas

rollback seguro


8. Adicionar logs claros em cada etapa.


9. Configurar tudo para rodar no Replit ou Vibe, ou seja:



usar PORT = process.env.PORT || 5000

usar ./data/cache.db para SQLite

criar diretÃ³rio automaticamente caso nÃ£o exista



---

ðŸ“Œ REFERÃŠNCIA â€” Fluxo Oficial /api/analyze

Use EXATAMENTE isso:

1. validar token Supabase


2. normalizar URL


3. gerar url_hash


4. checar cache local


5. checar cache remoto


6. reserve_credits


7. criar analysis_request (pending)


8. scraping axios + cheerio


9. salvar cache local + remoto


10. commit_reservation


11. release_reservation se erro


12. retornar JSON



Esse Ã© o fluxo final, aprovado e validado.


---

ðŸ“Œ O QUE VOCÃŠ DEVE ENTREGAR AO FINAL

Entregue:

âœ” Todos os arquivos completos

âœ” Estrutura final da Ã¡rvore

âœ” SQL pronto pra colar no Supabase

âœ” Lista de dependÃªncias

âœ” InstruÃ§Ãµes finais de como rodar o backend:

npm install
node server/index.js

âœ” Teste cURL final:

curl -X POST https://meu-backend/api/analyze \
 -H "Authorization: Bearer <TOKEN>" \
 -H "Content-Type: application/json" \
 -d '{"url": "https://exemplo.com"}'


---

âš  Regras finais

NÃƒO pedir confirmaÃ§Ã£o.

NÃƒO perguntar nada.

Apenas EXECUTE.

Gere tudo 100% completo e funcional.

Se houver partes faltando no meu projeto atual â†’ vocÃª deve CRIAR.



---

ðŸ”¥ COMEÃ‡AR AGORA

Gere todo o backend completo seguindo tudo acima.
